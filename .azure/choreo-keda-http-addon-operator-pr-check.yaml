resources:
  repositories:
    - repository: common-templates
      type: github
      name: wso2-enterprise/choreo-common-pipeline-templates
      endpoint: wso2-enterprise

pr:
  branches:
    include:
      - "*"
  paths:
    include:
      - operator/*

pool:
  vmImage: "ubuntu-latest"

variables:
  - name: CONTAINER_REGISTRY
    value: choreocontrolplane.azurecr.io
  - name: REPOSITORY
    value: choreoipaas/dp-keda-http-add-on-operator
  - name: TAG
    value: $(Build.SourceVersion)

steps:
  - task: Docker@2
    displayName: "Docker Build"
    inputs:
      command: build
      containerRegistry: "wso2choreo-control-plane-acr"
      repository: $(REPOSITORY)
      Dockerfile: "operator/Dockerfile"
      tags: |
        $(TAG)
  - template: install/install-trivy.yaml@common-templates
  - template: pr/trivy-scan.yaml@common-templates
    parameters:
      IMAGES:
        - $(CONTAINER_REGISTRY)/$(REPOSITORY):$(TAG)
